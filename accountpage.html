<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile â€“ Daily Slice</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
    
  
    
  <!-- same wrapper as Explore/Home -->
  <main class="phone phone--white profile-screen">
    <div class="status/errors" aria-live="polite">
        <h1 id="accountSettings" class="profile-username2">Account Settings</h1>
        <p id="userStatus" style="text-align: center;">Not signed in</p>
        <p id="displayname" style="text-align: center;"></p>
        <p id="SignInError" style="color: red; display:none; text-align: center;"></p>
    </div>
    <div class ="settingsWrapper">
         <div id="settings" style="display:none;">
          <div class="input-with-button">
            <input type="text" id="username" class="settingsInput" placeholder="Username">
            <button class="inputButton">Save</button>
          </div>

          <div class="input-with-button">
            <input type="text" id="birthday" class="settingsInput" placeholder="Birthday">
            <button class="inputButton">Save</button>
          </div>
        </div>

        <!-- User authentication buttons -->
        <div class="auth-container">
            <input type="email" id="email" class="loginInput" placeholder="Email: ">
            <input type="password" id="password" class="loginInput" placeholder="Password: ">
            <button id="signInButton">Log In</button>
            <button id="signUpButton">Sign Up</button>
            <button id="signOutButton" style="display:none;">Sign Out</button>
        </div>
</div>



  <script type="module">
      import {auth} from './firebase.js'
      import {createUserWithEmailAndPassword,
              signInWithEmailAndPassword,
              signOut,
              onAuthStateChanged,} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
      import {getFirestore, doc, setDoc, getDoc} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    window.addEventListener('DOMContentLoaded', () => {
    const db = getFirestore();
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const signUpBtn = document.getElementById('signUpButton');
    const signInBtn = document.getElementById('signInButton');
    const signOutBtn = document.getElementById('signOutButton');
    const userStatus = document.getElementById('userStatus');
    const SignInError = document.getElementById('SignInError');
    const username = document.getElementById('username');
    const birthday = document.getElementById('birthday');
    const saveButtons = document.querySelectorAll('.inputButton');
    const settings = document.getElementById('settings');
    
    
    

    saveButtons.forEach(button => {
      button.addEventListener('click', async () => {
        const input = button.previousElementSibling;
        const value = input.value;
        if (input.id === 'username') {
          console.log('Username saved:', value);
          await setDoc(doc(db, "UserAccounts", auth.currentUser.uid), {
            username: value
          }, { merge: true });
          document.getElementById('displayname').textContent = `${value}`;
        } else if (input.id === 'birthday') {
          console.log('Birthday saved:', value);
          await setDoc(doc(db, "UserAccounts", auth.currentUser.uid), {
            birthday: value
          }, { merge: true });
        }
      });
    });
    signUpBtn.addEventListener('click', async () => {
      try{
        const email = emailInput.value
        const password = passwordInput.value

        const userCredentials = await createUserWithEmailAndPassword(auth, email, password);
        const account = userCredentials

        await setDoc(doc(db, "UserAccounts", account.user.uid), {
          email: auth.currentUser.email,
          Score: 0,
          createdAt: new Date()

        });
        console.log("User signed up:", userCredentials.user);

        signUpButton.style.display = 'none';
        document.getElementById('settings').style.display = 'block';
        signInButton.style.display = 'none';
        signOutButton.style.display = 'inline';
        userStatus.textContent = `Signed in as: ${userCredentials.user.email}`;
        document.getElementById('email').style.display = 'none';
        document.getElementById('password').style.display = 'none';
        SignInError.style.display = 'none';
       
         signOutBtn.style.display = 'block';
            
      }catch (error) {
        console.error("Error signing up:", error);
        let message = "Sign up failed. ";
        if (error.code === "auth/email-already-in-use") {
          message += "Email already in use.";
        } else if (error.code === "auth/weak-password") {
          message += "Password should be at least 6 characters.";
        } else if (error.code === "auth/invalid-email") {
          message += "Invalid email address.";
        } else {
          message += error.message;
        }
        SignInError.textContent = message;
        SignInError.style.display = 'block';
       
      };
    });
    signInBtn.addEventListener('click', async () => {
      SignInError.style.display = 'none';
      try{
        const email = emailInput.value
        const password = passwordInput.value

        const userCredentials = await signInWithEmailAndPassword(auth, email, password);
        console.log("User signed in:", userCredentials.user);

        signUpButton.style.display = 'none';
        signInButton.style.display = 'none';
        document.getElementById('settings').style.display = 'block';
        userStatus.textContent = `Signed in as: ${userCredentials.user.email}`;
        document.getElementById('email').style.display = 'none';
        document.getElementById('password').style.display = 'none';
        SignInError.style.display = 'none';
        settings.style.display = 'block';
        signOutBtn.style.display = 'block';
        
      }catch (error) {
        console.error("Error signing in:", error);
        let message = "Sign in failed. ";
        if (error.code === "auth/user-not-found" || error.code === "auth/invalid-credential") {
          message += "Invalid email or password.";
        } else if (error.code === "auth/invalid-email") {
          message += "Invalid email address.";
        } else {
          message += error.message;
        }
        SignInError.textContent = message;
        SignInError.style.display = 'block';
        
      };
    });
    signOutBtn.addEventListener('click', async () => {
      try{
        await signOut(auth);
        console.log("User signed out");

        signUpButton.style.display = 'inline';
        signInButton.style.display = 'inline';
        signOutButton.style.display = 'none';
        userStatus.textContent = 'Not signed in';
        document.getElementById('email').style.display = 'inline';
        document.getElementById('password').style.display = 'inline';
        document.getElementById('settings').style.display = 'none';
        document.getElementById("displayname").textContent = '';
        SignInError.style.display = 'none';
      }catch (error) {
        console.error("Error signing out:", error);
      };
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        emailInput.style.display = 'none';
        passwordInput.style.display = 'none';
        signUpButton.style.display = 'none';
        signInButton.style.display = 'none';
        signOutButton.style.display = 'inline';
        userStatus.textContent = `Signed in as: ${user.email}`;
        document.getElementById('email').style.display = 'none';
        document.getElementById('password').style.display = 'none';
        document.getElementById('settings').style.display = 'block';
        SignInError.style.display = 'none';
        console.log("User is signed in:", user);
        const uid = user.uid;
        const userDocRef = doc(db, "UserAccounts", uid);
        const userSnap = await getDoc(userDocRef);
        if (userSnap.exists()) {
          const userData = userSnap.data();
          if (userData.username) {
            username.value = userData.username;
            document.getElementById('displayname').textContent = `${userData.username}`;
            document.getElementById('username').placeholder = `${userData.username}`;

          }
          if (userData.birthday) {
            birthday.value = userData.birthday;
          }
        } else {
          console.log("No such document!");
        }

        
      } else {
        console.log("No user is signed in.");
        emailInput.style.display = 'inline';
        passwordInput.style.display = 'inline';
        signUpButton.style.display = 'inline';
        signInButton.style.display = 'inline';
        signOutButton.style.display = 'none';
        userStatus.textContent = 'Not signed in';
        document.getElementById('email').style.display = 'inline';
        document.getElementById('password').style.display = 'inline';
        document.getElementById('username').placeholder = 'HUNGRY-OWL-2908';
        
        SignInError.style.display = 'none';
      }
    });
  })

  </script>
    <!-- bottom nav belongs inside the phone frame -->
    <nav class="bottom-nav" aria-label="Main navigation">
      <a href="index.html">
        <img src="assets/polygon.png" alt="Home" class="nav-icon home-icon">
      </a>
      <a href="explore.html">
        <img src="assets/search.png" alt="Search" class="nav-icon search-icon">
      </a>
      <a href="profile.html" aria-current="page">
        <img src="assets/icon.png" alt="Profile" class="nav-icon profile-icon active">
      </a>
    </nav>
  </main>
  
</body>
</html>
